<!DOCTYPE html>
<html>
<head>
<meta content="text/html; charset=UTF-8" http-equiv="content-type" />
<title>Home</title>
</head>
<body class="lift:content_id=main"
	xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#"
	xmlns:owl="http://www.w3.org/2002/07/owl#"
	xmlns:rdfs="http://www.w3.org/2000/01/rdf-schema#">
	<div id="main" class="lift:surround?with=default;at=content">
		<script data-lift="JSUtil.rdfa"></script>
		<div class="lift:rdfa">
			<div about="?this" class="row-fluid">
				<h3>
					<span class="lift:rdf.label"></span> &lt;<span class="lift:rdf.ref"></span>&gt;
				</h3>
				<section>
					<!-- sort by property -->
					<div class="clearable asc" about="?property"></div>

					<div class="row-fluid" data-clear-rel="?property">
						<div class="span3" style="font-weight: bold">
							<a href="/static/describe?model={model}&resource={}"
								class="lift:rdf.p:ref?to=href"><span
								class="lift:rdf.p:label"></span></a>
						</div>
						<div class="span9 union">
							<div class="row-fluid asc" rel="?property" resource="?oResource"
								data-filter="!isLiteral(?oResource)">
								<div class="span12">
									<a href="/static/describe?model={model}&resource={}"
										class="lift:rdf:ref?to=href"><span
										class="lift:rdf:manchester"></span></a> <span data-if="inferred"><i
										class="icon-share-alt" style="opacity: 0.5"></i></span>
								</div>
							</div>
							<div class="row-fluid asc" property="?property"
								content="?oLiteral" data-filter="isLiteral(?oLiteral)">
								<div class="span12">
									<span class="lift:rdf.label"></span> <span data-if="inferred"><i
										class="icon-share-alt" style="opacity: 0.5"></i></span>
								</div>
							</div>
						</div>
					</div>
				</section>
			</div>
			<br />
			<!-- show relevant properties for classes -->
			<div about="?this" typeof="rdfs:Class" class="row-fluid optional"
				data-if="?relevantProp">
				<h4>Relevant class properties</h4>
				<section>
					<!-- query relevant properties -->
					<span about="?this" rel="rdfs:subClassOf" class="clearable">
						<span rel="owl:onProperty" resource="?relevantProp"></span>
					</span>
					<ul about="?relevantProp">
						<li><a href="/static/describe?model={model}&resource={}"
							class="lift:rdf:ref?to=href"><span class="lift:rdf:label"></span></a></li>
					</ul>
				</section>
			</div>
		</div>

		<!-- add some editing support -->
		<script type="text/javascript" data-lift="head">
			var rdfAttributes = [ "about", "typeof", "rel", "rev", "property",
					"href", "resource", "src" ];

			$(function() {
				var buttons = $("#buttons");
				// relocate buttons for absolute positioning
				buttons.appendTo("body");

				$("[rel],[property]")
						.hover(
								function(e) {
									e.stopPropagation();
									var target = $(e.target);
									target = target.closest("[rel],[property]");
									if (!target.is(buttons.data("target"))
											|| !buttons.is(":visible")) {
										var lastTarget = buttons.data("target");
										if (lastTarget) {
											lastTarget.removeClass("focused");
										}

										target.addClass("focused");
										buttons.data("target", target);

										var parentOffset = buttons.parent()
												.offset();
										// position buttons to the right of target
										buttons.css({
											position : "absolute",
											marginLeft : 0,
											marginTop : 0,
											top : target.offset().top,
											left : target.offset().left
													+ target.innerWidth()
													- buttons.outerWidth()
										});
										buttons.css("display", "block");
									}
								},
								function(e) {
									var relatedTarget = $(e.relatedTarget);
									if (!relatedTarget
											|| (relatedTarget != buttons && relatedTarget
													.closest("#buttons").length == 0)) {
										var lastTarget = buttons.data("target");
										if (lastTarget) {
											lastTarget.removeClass("focused");
										}
										buttons.css("display", "none");
									}
								});
			});

			function remove() {
				var target = $("#buttons").data("target");
				if (target) {
					var body = $("body");
					var rdfBefore = body.rdf();
					target.remove();
					var rdfAfter = body.rdf();

					var data = rdfBefore.databank.except(rdfAfter.databank)
							.dump({
								serialize : true,
								format : "application/rdf+xml"
							});
					console.log(data);
					deleteTriples("removeCallback", data);
				}
				$("#buttons").hide();
			}

			function removeCallback() {
				notifications.notify("removed");
			}

			function edit() {
				function getFirstText(node) {
					if (node.nodeType == 3) {
						if ($.trim(node.nodeValue).length > 0)
							return node;
					} else {
						for ( var i = 0, len = node.childNodes.length; i < len; ++i) {
							var textNode = getFirstText(node.childNodes[i]);
							if (textNode)
								return textNode;
						}
					}
					return null;
				}

				var target = $("#buttons").data("target");
				if (target) {
					var firstText = getFirstText(target.get(0));
					if (firstText) {
						firstText = $(firstText);
						var input = $("<input type='text' name='edit'></input>");
						input.val($.trim(firstText.text()));

						var toReplace = firstText.closest("a");
						if (toReplace.length == 0)
							toReplace = firstText
						toReplace.replaceWith(input);
					}
				}
			}

			function showRdf() {
				var target = $("#buttons").data("target");
				if (target) {
					var body = $("body");
					var rdf = body.rdf();
					console.log(rdf.databank);
				}
			}
		</script>
		<style type="text/css" data-lift="head">
			/* make buttons slightly transparent */
			#buttons .btn { opacity: 0.6 }
			#buttons .btn:hover { opacity: 1 }
		</style>
		<div id="buttons" class="btn-toolbar" style="display: none">
			<div class="btn-group">
				<button class="btn btn-mini" title="Edit" onclick="edit()">
					<i class="icon-edit"></i>
				</button>
				<button class="btn btn-mini" title="Remove" onclick="remove()">
					<i class="icon-remove"></i>
				</button>
				<button class="btn btn-mini" title="Show RDF" onclick="showRdf()">
					<i class="icon-eye-open"></i>
				</button>
			</div>
		</div>
		<span data-lift="Edit"></span>
	</div>
</body>
</html>