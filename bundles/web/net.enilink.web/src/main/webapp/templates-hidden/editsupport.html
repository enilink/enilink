<!DOCTYPE html>
<html>
<body class="lift:content_id=main">
	<div id="main">
		<!-- add some editing support -->
		<script type="text/javascript" data-lift="head">
			var rdfAttributes = [ "about", "typeof", "rel", "rev", "property",
					"href", "resource", "src" ];

			$(function() {
				var buttons = $("#buttons");
				// relocate buttons for absolute positioning
				buttons.appendTo("body");

				$("[rel],[property]")
						.hover(
								function(e) {
									e.stopPropagation();
									var target = $(e.target);
									target = target.closest("[rel],[property]");
									if (!target.is(buttons.data("target"))
											|| !buttons.is(":visible")) {
										var lastTarget = buttons.data("target");
										if (lastTarget) {
											lastTarget.removeClass("focused");
										}

										target.addClass("focused");
										buttons.data("target", target);

										// position buttons to the right of target
										buttons.css({
											position : "absolute",
											marginLeft : 0,
											marginTop : 0,
											top : target.offset().top,
											left : target.offset().left
													+ target.innerWidth()
													- buttons.outerWidth()
										});
										buttons.css("display", "block");
									}
								},
								function(e) {
									var relatedTarget = $(e.relatedTarget);
									if (!relatedTarget
											|| (relatedTarget != buttons && relatedTarget
													.closest("#buttons").length == 0)) {
										var lastTarget = buttons.data("target");
										if (lastTarget) {
											lastTarget.removeClass("focused");
										}
										buttons.css("display", "none");
									}
								});
			});

			function remove() {
				var target = $("#buttons").data("target");
				if (target) {
					var body = $("body");
					var rdfBefore = body.rdf();
					target.remove();
					var rdfAfter = body.rdf();

					var data = rdfBefore.databank.except(rdfAfter.databank)
							.dump({
								serialize : true,
								format : "application/rdf+xml"
							});
					console.log(data);
					//deleteTriples("removeCallback", data);
				}
				$("#buttons").hide();
			}

			function removeCallback() {
				notifications.notify("removed");
			}

			function edit() {
				function getFirstText(node) {
					if (node.nodeType == 3) {
						if ($.trim(node.nodeValue).length > 0)
							return node;
					} else {
						for ( var i = 0, len = node.childNodes.length; i < len; ++i) {
							var textNode = getFirstText(node.childNodes[i]);
							if (textNode)
								return textNode;
						}
					}
					return null;
				}

				var target = $("#buttons").data("target");
				if (target) {
					var firstText = getFirstText(target.get(0));
					if (firstText) {
						firstText = $(firstText);
						var input = $("<textarea />").width(target.width())
								.height(target.height());
						input.val($.trim(firstText.text()));
						input.autogrow();

						var toReplace = firstText.closest("a");
						if (toReplace.length == 0)
							toReplace = firstText
						toReplace.replaceWith(input);

						// focus input and move caret to end of text
						input.caretToEnd();

						// discard changes if pressing esc
						input.keydown(function(e) {
							if (e.keyCode == 27) {
								e.preventDefault();
								input.replaceWith(toReplace);
							}
						});
					}
				}
			}

			function showRdf() {
				var target = $("#buttons").data("target");
				if (target) {
					var body = $("body");
					var rdf = body.rdf();
					console.log(rdf.databank);
				}
			}
		</script>
		<style type="text/css" data-lift="head">
/* make buttons slightly transparent */
#buttons .btn {
	opacity: 0.6
}

#buttons .btn:hover {
	opacity: 1
}
</style>
		<div id="buttons" class="btn-toolbar" style="display: none">
			<div class="btn-group">
				<button class="btn btn-mini" title="Edit" onclick="edit()">
					<i class="icon-edit"></i>
				</button>
				<button class="btn btn-mini" title="Remove" onclick="remove()">
					<i class="icon-remove"></i>
				</button>
				<button class="btn btn-mini" title="Show RDF" onclick="showRdf()">
					<i class="icon-eye-open"></i>
				</button>
			</div>
		</div>
		<div data-lift="Edit"></div>
		<div data-lift="JSUtil.edit"></div>
	</div>
</body>
</html>
