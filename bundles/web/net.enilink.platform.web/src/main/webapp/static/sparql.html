<div data-lift="surround?with=default;at=content"
     prefix="rdf: http://www.w3.org/1999/02/22-rdf-syntax-ns#
			 rdfs: http://www.w3.org/2000/01/rdf-schema#
			 owl: http://www.w3.org/2002/07/owl#
			 models: http://enilink.net/vocab/komma/models#
			 ">

    <link rel="stylesheet"
          href="/classpath/webjars/awesome.me__webawesome/*/dist-cdn/styles/themes/default.css"/>
    <script type="module"
            src="/classpath/webjars/awesome.me__webawesome/*/dist-cdn/webawesome.loader.js"></script>

    <script src="/classpath/webjars/zazuko__yasgui/*/static/yasgui.polyfill.min.js"></script>
    <script defer="defer" src="/classpath/webjars/zazuko__yasgui/*/build/yasgui.min.js"></script>
    <script defer="defer" src="/classpath/webjars/zazuko__yasqe/*/build/yasqe.min.js"></script>
    <script defer="defer" src="/classpath/webjars/zazuko__yasr/*/build/yasr.min.js"></script>

    <style>
        .yasgui .label, .yasgui input {
            color: revert;
            font-size: revert;
        }

        .yasgui .textRow {
            display: flex;
            gap: 5px;
        }
    </style>

    <link href="/classpath/webjars/zazuko__yasgui/*/build/yasgui.min.css" rel="stylesheet">
    <link href="/classpath/webjars/zazuko__yasqe/*/build/yasqe.min.css" rel="stylesheet">
    <link href="/classpath/webjars/zazuko__yasr/*/build/yasr.min.css" rel="stylesheet">

    <script>
        function getDescribeHref(resource) {
            return `../describe?model=${ encodeURIComponent($('#model').val()) }&resource=${ encodeURIComponent(resource) }`;
        }

        $(function() {
            require(['Yasgui', '/classpath/webjars/dompurify/*/dist/purify.min.js'], function(Yasgui, dompurify) {
                // Override getCellContent to add links to URIs and BNodes
                const originalGetCellContent = window.Yasr.plugins.table.prototype.getCellContent;
                window.Yasr.plugins.table.prototype.getCellContent = function (binding, prefixes) {
                    let content;
                    if (binding.type === 'uri') {
                        let label =  binding.value;
                        let prefixed = false;
                        if (prefixes) {
                          for (const prefix in prefixes) {
                            if (label.startsWith(prefixes[prefix])) {
                              label = prefix + ":" + label.substring(prefixes[prefix].length);
                              prefixed = true;
                              break;
                            }
                          }
                        }
                        // Hide brackets when prefixed or compact
                        const hideBrackets = prefixed || this.persistentConfig.compact;
                        content = `<span>${hideBrackets ? "" : "&lt;"}<a class='iri' target='${
                          this.config.openIriInNewWindow ? "_blank" : "_self"
                        }'${this.config.openIriInNewWindow ? " ref='noopener noreferrer'" : ""}
                        href='${ getDescribeHref( binding.value) }'>${ dompurify.sanitize(label) }</a>${hideBrackets ? "" : "&gt;"}</span>`;
                    } else if (binding.type === 'bnode') {
                        content = `<a class="bnode" target='${
                          this.config.openIriInNewWindow ? "_blank" : "_self"
                        }'${this.config.openIriInNewWindow ? " ref='noopener noreferrer'" : ""}
                        href='${ getDescribeHref( binding.value) }'>${ dompurify.sanitize(binding.value) }</a>`;
                    } else {
                        content = `<span class='nonIri'>${ this.formatLiteral(binding, prefixes) }</span>`;
                    }
                    return `<div>${content}</div>`;
                };

                window.yasgui = new Yasgui(document.getElementById("yasgui"), {
                    corsProxy: "",
                    requestConfig: {
                        endpoint: window.location.origin + "/sparql",
                        args: (yasqe) => {
                            return [{ name: "model", value: $('#model').val() }];
                        }
                    },
                    endpointCatalogueOptions: {
                        getData: () => {
                          return [
                            {
                              endpoint: window.location.origin + "/sparql"
                            }
                          ];
                        }
                    }
                });

                // required to fix the issue: https://github.com/zazuko/Yasgui/issues/44
                yasgui.on("tabChange", (instance, tab) => {
                   delete tab.persistentJson.requestConfig.args;
                });
            });
        });
    </script>

    <wa-card appearance="outlined">
        <div slot="header">
            <form class="form-inline" id="form">
                <div class="form-group">
                    <label for="model">Model</label>
                    <select class="form-control" id="model" data-lift="rdfa?target=meta">
                        <option about="?model" typeof="models:Model" class="asc model"
                                value="$model" data-lift="rdf.label"></option>
                        <div data-for="?model" class="acl"></div>
                    </select>
                </div>
            </form>
        </div>

        <div id="yasgui"></div>
    </wa-card>
</div>