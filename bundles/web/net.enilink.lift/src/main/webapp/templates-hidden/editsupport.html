<!DOCTYPE html>
<html>
<body class="lift:content_id=main">
	<div id="main">
		<script src="/classpath/require/require.js" data-lift="head"></script>

		<script data-lift="JS.rdfa"></script>

		<link href="/classpath/bootstrap-editable/css/bootstrap-editable.css"
			rel="stylesheet" data-lift="head">
		<script src="/classpath/bootstrap-editable/js/bootstrap-editable.js"
			data-lift="head"></script>
		<link href="/classpath/orion/built-editor.css" rel="stylesheet"
			data-lift="head">
		<script src="/classpath/orion/editable/editable-input-orion.js"
			data-lift="head"></script>
		<style>
.editable-form-control,.editable-container.editable-inline,.editable-container.editable-inline>*
	{
	width: 100%;
}

.editable-input {
	width: 83.3333%;
}

.editable-buttons {
	margin-left: 0
}
</style>
		<script type="text/javascript" data-lift="head">
			$.fn.editableform.template = '<form class="editableform" role="form">'
					+ '<div class="row">'
					+ '<div class="editable-input col-sm-10"></div>'
					+ '<div class="col-sm-2">'
					+ '<div class="editable-lang" style="display:none;"><div class="input-group" style="padding-bottom: 5px"><span class="input-group-addon">@</span><input class="form-control input-sm" style="max-width:40px" type="text" placeholder="lang"></div></div>'
					+ '<div class="editable-buttons"></div>'
					+ '</div>'
					+ '</div>'
					+ '<div class="editable-error-block"></div>'
					+ '</form>';

			(function() {
				function firstValue(rdfStmts) {
					var first;
					$.each(rdfStmts, function(i, po) {
						$.each(po, function(j, val) {
							if (val.length) {
								first = val[0];
							}
							return true;
						});
						return true;
					});
					return first;
				}

				function triggerLanguageInput(target, rdfStmts) {
					function supportsLang(l) {
						return l.type == "literal"
								&& (!l.datatype || l.datatype == "http://www.w3.org/1999/02/22-rdf-syntax-ns#langString");
					}
					function showInput(lang) {
						target.off("shown.editable-lang").on(
								"shown.editable-lang",
								function(e, editable) {
									var form = editable.container.$form;
									var editLang = form.find(".editable-lang");
									editLang.find("input")
											.val(lang ? lang : "");
									editLang.show();
								});
					}
					var first = firstValue(rdfStmts);
					if (first && supportsLang(first)) {
						showInput(first.lang);
					}
				}

				function prepareEditable(target, rdfStmts) {
					triggerLanguageInput(target, rdfStmts);
				}

				function defaultEditableOptions(rdfStmts) {
					var resourceProposal;
					return {
						type : "orion",
						onblur : "ignore",
						inputclass : "editable-form-control",
						mode : "inline",
						toggle : "manual",
						savenochange : true,
						params : function(params) {
							var value = $.trim(params.value);
							if (resourceProposal
									&& resourceProposal.proposal == value) {
								// use selected resource as value
								params.value = "<" + resourceProposal.resource + ">";
							} else {
								// set correct language
								var old = firstValue(rdfStmts);
								var lang = $(this).data('editable').container.$form
										.find(".editable-lang input").val();
								if (lang) {
									params.value = $.rdf.literal(value, {
										lang : lang
									});
								} else if (old && old.lang) {
									params.value = $.rdf.literal('"' + value
											+ '"');
								}
							}
							return params;
						},
						contentAssistProposalApplied : function(proposal) {
							if (proposal.resource) {
								resourceProposal = proposal;
							}
						},
						contentAssistProviders : [ {
							computeProposals : function(buffer, offset, context) {
								var dfd = new $.Deferred();
								enilink
										.propose(
												{
													rdf : rdfStmts,
													query : buffer.substring(0,
															offset),
													index : offset
												},
												function(results) {
													var proposals = [];
													$
															.each(
																	results,
																	function(
																			index,
																			value) {
																		var positions = [];
																		var escapePosition = value.insert ? offset
																				+ value.content.length
																				: value.content.length;
																		var proposal = {
																			proposal : value.content,
																			description : value.description,
																			escapePosition : escapePosition,
																			insert : value.insert
																		};
																		if (value.resource) {
																			// this is a resource proposal
																			proposal.resource = value.resource;
																		}
																		if (value.perfectMatch) {
																			// use emphasis style
																			proposal.style = "emphasis";
																		}
																		proposals
																				.push(proposal);
																	});
													dfd.resolve(proposals);
												});
								return dfd.promise();
							}
						} ]
					};
				}

				function doEdit(target, options) {
					// global deferred to allow the execution of 
					// functions after doAdd finished
					var resultDeferred = new $.Deferred;
					var triples = target.rdf().databank.triples();
					var value = null;
					if (triples.length && triples[0].object.type == "literal") {
						// TODO implement real localized formatting
						value = triples[0].object.value + "";
					} else {
						value = target.closest("[content]").attr("content")
								|| target.text().trim();
					}
					var rdfStmts = $.rdf.dump(triples);
					options = $.extend(defaultEditableOptions(rdfStmts), {
						title : "Edit value",
						value : value,
						display : function(value, response) {
							if (response && response.html) {
								var newNode = $(response.html);
								// replaceWith does not work for some reason here
								//target.replaceWith(newNode);
								newNode.insertAfter(target);
								target.remove();
								if (enilink.options["ui.autoEdit"]) {
									enableEdit(newNode);
								}
								resultDeferred.resolve(newNode);
							}
							return null;
						},
						url : function(params) {
							var d = new $.Deferred;
							enilink.setValue({
								rdf : rdfStmts,
								value : params.value,
								template : target.attr("data-t"),
								what : target.closest("[data-t-path]").attr(
										"data-t-path")
							}, function(result) {
								if (result.msg) {
									d.reject(result.msg);
									resultDeferred.reject(result.msg);
								} else {
									d.resolve(result);
								}
							});
							return d.promise();
						}
					}, options || {});

					prepareEditable(target, rdfStmts);
					target.editable(options);
					target.editable("show");
					return resultDeferred.promise();
				}

				function doAdd(self, options) {
					// global deferred to allow the execution of 
					// functions after doAdd finished
					var resultDeferred = new $.Deferred;
					var e = self.closest("[property], [data-property]")
					var property = e.attr("property")
							|| e.attr("data-property");
					var predicate = property;
					if (!predicate) {
						e = self.closest("[rel], [data-rel]");
						predicate = e.attr("rel") || e.attr("data-rel");
					}
					e = self.closest("[resource], [about]");
					var subject = e.attr("resource") || e.attr("about");
					var object = property ? $.rdf.literal('""') : $.rdf
							.resource("<urn:null>");
					if (subject && predicate) {
						// explicit creation of blank node objects
						if (subject.match(/^_:/)) {
							subject = $.rdf.blank(subject);
						}
						var nsMap = self.xmlns();
						var stmt = $.rdf.databank(
								[ $.rdf.triple(subject, predicate, object, {
									namespaces : nsMap
								}) ]).dump();
						options = $.extend(defaultEditableOptions(stmt), {
							display : false,
							success : function(response) {
								if (options.onadd) {
									$.when(options.onadd(response)).then(
											function(value) {
												resultDeferred.resolve(value);
											}).fail(function(reason) {
										resultDeferred.reject(reason);
									});
									return;
								}
								if (response.html) {
									var newNode = $(response.html);
									newNode.insertBefore(self);
									if (enilink.options["ui.autoEdit"]) {
										enableEdit(newNode);
									}
									resultDeferred.resolve(newNode);
								}
							},
							value : "",
							title : "Add value",
							url : function(params) {
								var d = new $.Deferred;
								enilink.setValue({
									rdf : stmt,
									value : params.value,
									template : self.attr("data-add"),
									what : self.closest("[data-t-path]").attr(
											"data-t-path")
								}, function(result) {
									if (result.msg) {
										d.reject(result.msg);
										resultDeferred.reject(result.msg);
									} else {
										d.resolve(result);
									}
								});
								return d.promise();
							}
						}, options || {});
						prepareEditable(self, stmt);
						self.editable(options);
						self.editable("show");
					} else {
						resultDeferred
								.reject("Subject and predicate must be defined.")
					}
					return resultDeferred.promise();
				}
				function addHandler(e) {
					e.stopPropagation();
					e.preventDefault();
					var self = $(this);
					var onadd = self.data("onadd");
					var options = {};
					if (onadd) {
						onadd = eval.call(window, "(" + onadd + ")");
						if (typeof onadd === "function") {
							options.onadd = onadd;
						}
					}
					doAdd(self, options);
				}

				function enableAdd(nodeOrSelector) {
					// allow to use selectors or DOM nodes as arguments
					nodeOrSelector = (nodeOrSelector instanceof jQuery) ? nodeOrSelector
							: $(nodeOrSelector);
					nodeOrSelector.click(addHandler);
				}

				var buttons;
				function hideButtons() {
					var lastTarget = buttons.data("target");
					if (lastTarget) {
						lastTarget.removeClass("focused");
					}
					buttons.hide();
				}

				function enableEdit(nodeOrSelector) {
					// allow to use selectors or DOM nodes as arguments
					nodeOrSelector = (nodeOrSelector instanceof jQuery) ? nodeOrSelector
							: $(nodeOrSelector);
					nodeOrSelector
							.filter(
									function() {
										var self = $(this);
										return self
												.is("[rel],[rev],[property]")
												|| self
														.parent()
														.closest(
																"[rel],[resource],[href],[about]")
														.not(
																"[resource],[href]")
														.is("[rel],[rev]");
									})
							.hover(
									function(e) {
										e.stopPropagation();
										var target = $(e.target)
												.closest(
														"[about],[resource],[property]");
										if (target.length == 0) {
											return;
										}
										if (!target.is(buttons.data("target"))
												|| !buttons.is(":visible")) {
											var lastTarget = buttons
													.data("target");
											if (lastTarget) {
												lastTarget
														.removeClass("focused");
											}
											target.addClass("focused");
											buttons.data("target", target);

											var top, left;
											if (target.innerWidth() <= buttons
													.outerWidth()
													|| target.innerHeight() <= buttons
															.outerHeight()) {
												top = target.offset().top;
												left = target.offset().left
														+ target.outerWidth()
														- 5;
											} else {
												top = target.offset().top;
												left = target.offset().left
														+ target.innerWidth()
														- buttons.outerWidth();
											}

											// position buttons to the right of target
											buttons.css({
												position : "absolute",
												marginLeft : 0,
												marginTop : 0,
												top : top,
												left : left
											});
											buttons.show();
										}
									},
									function(e) {
										var relatedTarget = $(e.relatedTarget);
										if (!relatedTarget
												|| (relatedTarget != buttons && relatedTarget
														.closest("#buttons").length == 0)) {
											hideButtons();
										}
									});
				}

				// allow access through global enilink object
				enilink = window.enilink || {};
				enilink.ui = $.extend(enilink.ui || {}, {
					enableEdit : enableEdit,
					enableAdd : enableAdd,
					edit : doEdit,
					add : doAdd,
					defaultEditableOptions : defaultEditableOptions
				});
				enilink.options = $.extend({
					"ui.autoEdit" : true
				}, enilink.options || {});

				$(function() {
					buttons = $("#buttons");
					// relocate buttons for absolute positioning
					buttons.css("z-index", "1000000")
					buttons.appendTo("body");

					function editHandler(e) {
						e.stopPropagation();
						e.preventDefault();
						var target = $("#buttons").data("target");
						if (target) {
							hideButtons();
							doEdit(target);
						}
					}
					$("#buttons .button-edit").click(editHandler);

					function remove() {
						var target = $("#buttons").data("target");
						if (target) {
							var toDelete = target.rdf().databank.dump();
							console.log("Delete: " + toDelete);
							// enilink.updateTriples(null, toDelete,
							enilink.removeValue(toDelete, function(success) {
								if (success) {
									target.remove();
								}
							});
						}
						hideButtons();
					}
					$("#buttons .button-remove").click(remove);

					function showRdf() {
						var target = $("#buttons").data("target");
						if (target) {
							var rdf = target.rdf();
							console.log(rdf.databank);
							console.log(rdf.databank.dump());
						}
					}
					$("#buttons .button-show").click(showRdf);

					if (enilink.options["ui.autoEdit"]) {
						enableEdit("[about],[resource],[property]");
						enableAdd("[data-add]");
					}
				});
			})();
		</script>
		<style type="text/css" data-lift="head">
/* highlight emphasized proposals */
.contentassist .proposal-emphasis {
	font-weight: bold;
}

/* make buttons slightly transparent */
[data-add] {
	opacity: 0.3;
	cursor: pointer;
}

#buttons .btn {
	opacity: 0.6
}

#buttons .btn:hover,[data-add]:hover {
	opacity: 1
}
</style>
		<div id="buttons" class="btn-toolbar" style="display: none">
			<div class="btn-group">
				<button class="btn btn-default btn-xs button-edit" title="Edit">
					<i class="glyphicon glyphicon-edit"></i>
				</button>
				<button class="btn btn-default btn-xs button-remove" title="Remove">
					<i class="glyphicon glyphicon-remove"></i>
				</button>
				<button class="btn btn-default btn-xs button-show" title="Show RDF">
					<i class="glyphicon glyphicon-eye-open"></i>
				</button>
			</div>
		</div>
		<div data-lift="Edit"></div>
	</div>
</body>
</html>