<!DOCTYPE html>
<html>
<body class="lift:content_id=main">
	<div id="main">
		<script src="/classpath/require/require.js" data-lift="head"></script>

		<link href="/classpath/bootstrap-editable/css/bootstrap-editable.css"
			rel="stylesheet" data-lift="head">
		<script src="/classpath/bootstrap-editable/js/bootstrap-editable.js"
			data-lift="head"></script>
		<link href="/classpath/orion/built-editor.css" rel="stylesheet"
			data-lift="head">
		<script src="/classpath/orion/editable/editable-input-orion.js"
			data-lift="head"></script>

		<script type="text/javascript" data-lift="head">
			var rdfAttributes = [ "about", "typeof", "rel", "rev", "property",
					"href", "resource", "src" ];

			$(function() {
				var buttons = $("#buttons");
				// relocate buttons for absolute positioning
				buttons.appendTo("body");

				function makeEditable(target) {
					target.hover(function(e) {
						e.stopPropagation();
						var target = $(e.target).closest("[rel],[property]");
						if (!target.is(buttons.data("target"))
								|| !buttons.is(":visible")) {
							var lastTarget = buttons.data("target");
							if (lastTarget) {
								lastTarget.removeClass("focused");
							}
							target.addClass("focused");
							buttons.data("target", target);

							// position buttons to the right of target
							buttons.css({
								position : "absolute",
								marginLeft : 0,
								marginTop : 0,
								top : target.offset().top,
								left : target.offset().left
										+ target.innerWidth()
										- buttons.outerWidth()
							});
							buttons.show();
						}
					}, function(e) {
						var relatedTarget = $(e.relatedTarget);
						if (!relatedTarget
								|| (relatedTarget != buttons && relatedTarget
										.closest("#buttons").length == 0)) {
							var lastTarget = buttons.data("target");
							if (lastTarget) {
								lastTarget.removeClass("focused");
							}
							buttons.hide();
						}
					})
				}

				makeEditable($("[rel],[property]"));

				function updateModel(rdfBefore, rdfAfter, callback) {
					var toDelete = rdfBefore.databank.except(rdfAfter.databank)
							.dump({
								serialize : true,
								format : "application/rdf+xml"
							});
					var toAdd = rdfAfter.databank.except(rdfBefore.databank)
							.dump({
								serialize : true,
								format : "application/rdf+xml"
							});
					console.log("Adding: " + toAdd);
					console.log("Delete: " + toDelete);
					updateTriples(toAdd, toDelete, callback);
				}

				function remove() {
					var target = $("#buttons").data("target");
					if (target) {
						var body = $("body");
						var rdfBefore = body.rdf();
						target.remove();
						updateModel(rdfBefore, body.rdf());
					}
					$("#buttons").hide();
				}
				$("#buttons .buttons-remove").click(remove);

				function showRdf() {
					var target = $("#buttons").data("target");
					if (target) {
						var rdf = target.rdf();
						console.log(rdf.databank);
					}
				}
				$("#buttons .buttons-show").click(showRdf);

				function createEditableOptions(rdfStmts) {
					var resourceProposal;
					return {
						type : "orion",
						onblur : "ignore",
						inputclass : "input-xxlarge",
						mode : "inline",
						toggle : "manual",
						params : function(params) {
							var value = $.trim(params.value);
							if (resourceProposal
									&& resourceProposal.proposal == value) {
								// use selected resource as value
								params.value = "<" + resourceProposal.resource + ">";
							}
							return params;
						},
						contentAssistProposalApplied : function(proposal) {
							if (proposal.resource) {
								resourceProposal = proposal;
							}
						},
						contentAssistProviders : [ {
							computeProposals : function(buffer, offset, context) {
								var dfd = new $.Deferred();
								propose(
										{
											rdf : rdfStmts,
											query : buffer.substring(0, offset),
											index : offset
										},
										function(results) {
											var proposals = [];
											$
													.each(
															results,
															function(index,
																	value) {
																var positions = [];
																var escapePosition = value.insert ? offset
																		+ value.content.length
																		: value.content.length;
																var proposal = {
																	proposal : value.content,
																	description : value.description,
																	escapePosition : escapePosition,
																	insert : value.insert
																};
																if (value.resource) {
																	// this is a resource proposal
																	proposal.resource = value.resource;
																}
																proposals
																		.push(proposal);
															});
											dfd.resolve(proposals);
										});
								return dfd.promise();
							}
						} ]
					};
				}

				function doEdit(e) {
					e.stopPropagation();
					e.preventDefault();
					var target = $("#buttons").data("target");
					if (target) {
						var rdfStmts = target.rdf().databank.dump({
							serialize : true,
							format : "application/rdf+xml"
						});
						var options = createEditableOptions(rdfStmts);
						options = $.extend(options, {
							title : "Edit value",
							value : target.closest("[content]").attr("content")
									|| target.text().trim(),
							display : function(value, response) {
								if (response && response.html) {
									var newNode = $(response.html);
									// replaceWith does not work for some reason here
									//target.replaceWith(newNode);
									newNode.insertAfter(target);
									target.remove();
									makeEditable(newNode);
								} else {
									target.html(value);
								}
							},
							url : function(params) {
								var d = new $.Deferred();
								setValue({
									rdf : rdfStmts,
									value : params.value,
									templateName : target.attr("data-t")
								}, function(result) {
									if (result.msg) {
										d.reject(result.msg);
									} else {
										d.resolve(result);
									}
								});
								return d.promise();
							}
						});
						target.editable(options);
						target.editable("toggle");
					}
				}
				$("#buttons .buttons-edit").click(doEdit);

				function doAdd(e) {
					e.stopPropagation();
					e.preventDefault();

					var self = $(this);
					var e = self.closest("[property], [data-property]")
					var property = e.attr("property")
							|| e.attr("data-property");
					var predicate = property;
					if (!predicate) {
						e = self.closest("[rel], [data-rel]");
						predicate = e.attr("rel") || e.attr("data-rel");
					}
					e = self.closest("[resource], [about]");
					var subject = e.attr("resource") || e.attr("about");
					var object = property ? $.rdf.literal("\"\"") : $.rdf.resource("<urn:null>");
					if (subject && predicate) {
						var stmt = $.rdf.databank(
								[ $.rdf.triple(subject, predicate, object, {
									namespaces : self.xmlns()
								}) ]).dump({
							serialize : true,
							format : "application/rdf+xml"
						});
						var options = createEditableOptions(stmt);
						options = $.extend(options, {
							display : false,
							success : function(response) {
								if (response.html) {
									var newNode = $(response.html);
									newNode.insertBefore(self);
									makeEditable(newNode);
								}
							},
							value : "",
							title : "Add value",
							url : function(params) {
								var d = new $.Deferred;
								setValue({
									rdf : stmt,
									value : params.value,
									templateName : self.attr("data-add")
								}, function(result) {
									if (result.msg) {
										d.reject(result.msg);
									} else {
										d.resolve(result);
									}
								});
								return d.promise();
							}
						});
						self.editable(options);
						self.editable("toggle");
					}
				}
				$("[data-add]").click(doAdd).css("cursor", "pointer");
			});
		</script>
		<style type="text/css" data-lift="head">
/* make buttons slightly transparent */
[data-add] {
	opacity: 0.3
}

#buttons .btn {
	opacity: 0.6
}

#buttons .btn:hover,[data-add]:hover {
	opacity: 1
}
</style>
		<div id="buttons" class="btn-toolbar" style="display: none">
			<div class="btn-group">
				<button class="btn btn-mini buttons-edit" title="Edit">
					<i class="icon-edit"></i>
				</button>
				<button class="btn btn-mini buttons-remove" title="Remove">
					<i class="icon-remove"></i>
				</button>
				<button class="btn btn-mini buttons-show" title="Show RDF">
					<i class="icon-eye-open"></i>
				</button>
			</div>
		</div>
		<div data-lift="Edit"></div>
	</div>
</body>
</html>