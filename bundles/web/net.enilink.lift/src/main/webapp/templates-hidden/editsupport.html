<!DOCTYPE html>
<html>
<body class="lift:content_id=main">
	<div id="main">
		<script src="/classpath/require/require.js" data-lift="head"></script>

		<script data-lift="JS.rdfa"></script>

		<link href="/classpath/bootstrap-editable/css/bootstrap-editable.css"
			rel="stylesheet" data-lift="head">
		<script src="/classpath/bootstrap-editable/js/bootstrap-editable.js"
			data-lift="head"></script>
		<link href="/classpath/orion/built-editor.css" rel="stylesheet"
			data-lift="head">
		<script src="/classpath/orion/editable/editable-input-orion.js"
			data-lift="head"></script>

		<script type="text/javascript" data-lift="head">
			$(function() {
				var buttons = $("#buttons");
				// relocate buttons for absolute positioning
				buttons.appendTo("body");

				function hideButtons() {
					var lastTarget = buttons.data("target");
					if (lastTarget) {
						lastTarget.removeClass("focused");
					}
					buttons.hide();
				}

				var rdfXmlOpts = {
					serialize : true,
					format : "application/rdf+xml"
				};
				function remove() {
					var target = $("#buttons").data("target");
					if (target) {
						var toDelete = target.rdf().databank.dump(rdfXmlOpts);
						console.log("Delete: " + toDelete);
						enilink.updateTriples(null, toDelete,
								function(success) {
									if (success) {
										target.remove();
									}
								});
					}
					hideButtons();
				}
				$("#buttons .button-remove").click(remove);

				function showRdf() {
					var target = $("#buttons").data("target");
					if (target) {
						var rdf = target.rdf();
						console.log(rdf.databank);
					}
				}
				$("#buttons .button-show").click(showRdf);

				function defaultEditableOptions(rdfStmts) {
					var resourceProposal;
					return {
						type : "orion",
						onblur : "ignore",
						inputclass : "input-xxlarge",
						mode : "inline",
						toggle : "manual",
						params : function(params) {
							var value = $.trim(params.value);
							if (resourceProposal
									&& resourceProposal.proposal == value) {
								// use selected resource as value
								params.value = "<" + resourceProposal.resource + ">";
							}
							return params;
						},
						contentAssistProposalApplied : function(proposal) {
							if (proposal.resource) {
								resourceProposal = proposal;
							}
						},
						contentAssistProviders : [ {
							computeProposals : function(buffer, offset, context) {
								var dfd = new $.Deferred();
								enilink
										.propose(
												{
													rdf : rdfStmts,
													query : buffer.substring(0,
															offset),
													index : offset
												},
												function(results) {
													var proposals = [];
													$
															.each(
																	results,
																	function(
																			index,
																			value) {
																		var positions = [];
																		var escapePosition = value.insert ? offset
																				+ value.content.length
																				: value.content.length;
																		var proposal = {
																			proposal : value.content,
																			description : value.description,
																			escapePosition : escapePosition,
																			insert : value.insert
																		};
																		if (value.resource) {
																			// this is a resource proposal
																			proposal.resource = value.resource;
																		}
																		proposals
																				.push(proposal);
																	});
													dfd.resolve(proposals);
												});
								return dfd.promise();
							}
						} ]
					};
				}

				function doEdit(target, options) {
					// global deferred to allow the execution of 
					// functions after doAdd finished
					var resultDeferred = new $.Deferred;
					var rdfStmts = target.rdf().databank.dump(rdfXmlOpts);
					var d = new $.Deferred;
					options = $.extend(defaultEditableOptions(rdfStmts), {
						title : "Edit value",
						value : target.closest("[content]").attr("content")
								|| target.text().trim(),
						display : function(value, response) {
							if (response && response.html) {
								var newNode = $(response.html);
								// replaceWith does not work for some reason here
								//target.replaceWith(newNode);
								newNode.insertAfter(target);
								target.remove();
								enableEdit(newNode);
								resultDeferred.resolve(newNode);
							} else {
								target.html(value);
								resultDeferred.resolve(target);
							}
						},
						url : function(params) {
							enilink.setValue({
								rdf : rdfStmts,
								value : params.value,
								templateName : target.attr("data-t"),
								templatePath : target.closest("[data-t-path]")
										.attr("data-t-path")
							}, function(result) {
								if (result.msg) {
									d.reject(result.msg);
									resultDeferred.reject(result.msg);
								} else {
									d.resolve(result);
								}
							});
							return d.promise();
						}
					}, options || {});
					target.editable(options);
					target.editable("toggle");
					return resultDeferred.promise();
				}

				function editHandler(e) {
					e.stopPropagation();
					e.preventDefault();
					var target = $("#buttons").data("target");
					if (target) {
						hideButtons();
						doEdit(target);
					}
				}
				$("#buttons .button-edit").click(editHandler);

				function doAdd(self, options) {
					// global deferred to allow the execution of 
					// functions after doAdd finished
					var resultDeferred = new $.Deferred;
					var e = self.closest("[property], [data-property]")
					var property = e.attr("property")
							|| e.attr("data-property");
					var predicate = property;
					if (!predicate) {
						e = self.closest("[rel], [data-rel]");
						predicate = e.attr("rel") || e.attr("data-rel");
					}
					e = self.closest("[resource], [about]");
					var subject = e.attr("resource") || e.attr("about");
					var object = property ? $.rdf.literal("\"\"") : $.rdf
							.resource("<urn:null>");
					if (subject && predicate) {
						// explicit creation of blank node objects
						if (subject.match(/^_:/)) {
							subject = $.rdf.blank(subject);
						}
						var nsMap = self.xmlns();
						var stmt = $.rdf.databank(
								[ $.rdf.triple(subject, predicate, object, {
									namespaces : nsMap
								}) ]).dump(rdfXmlOpts);
						var d = new $.Deferred;
						options = $.extend(defaultEditableOptions(stmt), {
							display : false,
							success : function(response) {
								if (response.html) {
									var newNode = $(response.html);
									newNode.insertBefore(self);
									enableEdit(newNode);
									resultDeferred.resolve(newNode);
								}
							},
							value : "",
							title : "Add value",
							url : function(params) {
								enilink.setValue({
									rdf : stmt,
									value : params.value,
									templateName : self.attr("data-add"),
									templatePath : self
											.closest("[data-t-path]").attr(
													"data-t-path")
								}, function(result) {
									if (result.msg) {
										d.reject(result.msg);
										resultDeferred.reject(result.msg);
									} else {
										d.resolve(result);
									}
								});
								return d.promise();
							}
						}, options || {});
						self.editable(options);
						self.editable("toggle");
					} else {
						resultDeferred
								.reject("Subject and predicate must be defined.")
					}
					return resultDeferred.promise();
				}
				function addHandler(e) {
					e.stopPropagation();
					e.preventDefault();
					doAdd($(this));
				}

				function enableAdd(nodeOrSelector) {
					// allow to use selectors or DOM nodes as arguments
					nodeOrSelector = (nodeOrSelector instanceof jQuery) ? nodeOrSelector
							: $(nodeOrSelector);
					nodeOrSelector.click(addHandler);
				}

				function enableEdit(nodeOrSelector) {
					// allow to use selectors or DOM nodes as arguments
					nodeOrSelector = (nodeOrSelector instanceof jQuery) ? nodeOrSelector
							: $(nodeOrSelector);
					nodeOrSelector.hover(function(e) {
						e.stopPropagation();
						var target = $(e.target).closest("[rel],[property]");
						if (target.length == 0) {
							return;
						}
						if (!target.is(buttons.data("target"))
								|| !buttons.is(":visible")) {
							var lastTarget = buttons.data("target");
							if (lastTarget) {
								lastTarget.removeClass("focused");
							}
							target.addClass("focused");
							buttons.data("target", target);

							// position buttons to the right of target
							buttons.css({
								position : "absolute",
								marginLeft : 0,
								marginTop : 0,
								top : target.offset().top,
								left : target.offset().left
										+ target.innerWidth()
										- buttons.outerWidth()
							});
							buttons.show();
						}
					}, function(e) {
						var relatedTarget = $(e.relatedTarget);
						if (!relatedTarget
								|| (relatedTarget != buttons && relatedTarget
										.closest("#buttons").length == 0)) {
							hideButtons();
						}
					});
				}

				// allow access through global enilink object
				enilink = window.enilink || {};
				enilink.ui = $.extend(enilink.ui || {}, {
					enableEdit : enableEdit,
					enableAdd : enableAdd,
					edit : doEdit,
					add : doAdd,
					defaultEditableOptions : defaultEditableOptions
				});
				enilink.options = $.extend({
					"ui.autoEdit" : true
				}, enilink.options || {});

				if (enilink.options["ui.autoEdit"]) {
					enableEdit("[rel],[property]");
					enableAdd("[data-add]");
				}
			});
		</script>
		<style type="text/css" data-lift="head">
/* make buttons slightly transparent */
[data-add] {
	opacity: 0.3;
	cursor: pointer;
}

#buttons .btn {
	opacity: 0.6
}

#buttons .btn:hover,[data-add]:hover {
	opacity: 1
}
</style>
		<div id="buttons" class="btn-toolbar" style="display: none">
			<div class="btn-group">
				<button class="btn btn-mini button-edit" title="Edit">
					<i class="icon-edit"></i>
				</button>
				<button class="btn btn-mini button-remove" title="Remove">
					<i class="icon-remove"></i>
				</button>
				<button class="btn btn-mini button-show" title="Show RDF">
					<i class="icon-eye-open"></i>
				</button>
			</div>
		</div>
		<div data-lift="Edit"></div>
	</div>
</body>
</html>