<!DOCTYPE html>
<html>
<body class="lift:content_id=main">
	<div id="main">
		<!-- add some editing support -->
		<link href="/classpath/bootstrap-editable/css/bootstrap-editable.css"
			rel="stylesheet" data-lift="head">
		<script src="/classpath/bootstrap-editable/js/bootstrap-editable.js"
			data-lift="head"></script>
		<link href="/classpath/select2/select2.css" rel="stylesheet"
			data-lift="head">
		<script src="/classpath/select2/select2.js" data-lift="head"></script>

		<script type="text/javascript" data-lift="head">
			var rdfAttributes = [ "about", "typeof", "rel", "rev", "property",
					"href", "resource", "src" ];

			$(function() {
				var buttons = $("#buttons");
				// relocate buttons for absolute positioning
				buttons.appendTo("body");

				function makeEditable(target) {
					target.hover(function(e) {
						e.stopPropagation();
						var target = $(e.target).closest("[rel],[property]");
						if (!target.is(buttons.data("target"))
								|| !buttons.is(":visible")) {
							var lastTarget = buttons.data("target");
							if (lastTarget) {
								lastTarget.removeClass("focused");
							}
							target.addClass("focused");
							buttons.data("target", target);

							// position buttons to the right of target
							buttons.css({
								position : "absolute",
								marginLeft : 0,
								marginTop : 0,
								top : target.offset().top,
								left : target.offset().left
										+ target.innerWidth()
										- buttons.outerWidth()
							});
							buttons.css("display", "block");
						}
					}, function(e) {
						var relatedTarget = $(e.relatedTarget);
						if (!relatedTarget
								|| (relatedTarget != buttons && relatedTarget
										.closest("#buttons").length == 0)) {
							var lastTarget = buttons.data("target");
							if (lastTarget) {
								lastTarget.removeClass("focused");
							}
							buttons.css("display", "none");
						}
					})
				}

				makeEditable($("[rel],[property]"));

				function updateModel(rdfBefore, rdfAfter, callback) {
					var toDelete = rdfBefore.databank.except(rdfAfter.databank)
							.dump({
								serialize : true,
								format : "application/rdf+xml"
							});
					var toAdd = rdfAfter.databank.except(rdfBefore.databank)
							.dump({
								serialize : true,
								format : "application/rdf+xml"
							});
					console.log("Adding: " + toAdd);
					console.log("Delete: " + toDelete);
					updateTriples(toAdd, toDelete, callback);
				}

				function remove() {
					var target = $("#buttons").data("target");
					if (target) {
						var body = $("body");
						var rdfBefore = body.rdf();
						target.remove();
						updateModel(rdfBefore, body.rdf());
					}
					$("#buttons").hide();
				}
				$("#buttons .buttons-remove").click(remove);

				function showRdf() {
					var target = $("#buttons").data("target");
					if (target) {
						var rdf = target.rdf();
						console.log(rdf.databank);
					}
				}
				$("#buttons .buttons-show").click(showRdf);

				$("#buttons .buttons-edit").click(function(e) {
					e.stopPropagation();
					e.preventDefault();
					var target = $("#buttons").data("target");
					if (target) {
						target.editable({
							type : "textarea",
							inputclass : "input-xxlarge",
							mode : "inline",
							display : function(value, response) {
								if (response.html) {
									var newNode = $(response.html);
									target.replaceWith(newNode);
									makeEditable(newNode);
								} else {
									target.html(value);
								}
							},
							toggle : "manual",
							title : "Edit value",
							url : function(params) {
								var rdfStmts = target.rdf().databank.dump({
									serialize : true,
									format : "application/rdf+xml"
								});
								console.log(rdfStmts);
								var d = new $.Deferred;
								setValue({
									rdf : rdfStmts,
									value : params.value,
									templateName : target.attr("data-t")
								}, function(result) {
									if (result.msg) {
										d.reject(result.msg);
									} else {
										d.resolve(result);
									}
								});
								return d.promise();
							}
						});
						target.editable("toggle");
					}
				});
				$("[data-create]")
						.click(
								function(e) {
									e.stopPropagation();
									e.preventDefault();

									var self = $(this);
									var e = self
											.closest("[property], [data-property]")
									var property = e.attr("property")
											|| e.attr("data-property");
									var predicate = property;
									if (!predicate) {
										e = self.closest("[rel], [data-rel]");
										predicate = e.attr("rel")
												|| e.attr("data-rel");
									}
									e = self.closest("[resource], [about]");
									var subject = e.attr("resource")
											|| e.attr("about");
									var object = property ? $.rdf
											.literal("\"\"") : "urn:null";
									if (subject && predicate) {
										var stmt = $.rdf.databank(
												[ $.rdf.triple(subject,
														predicate, object, {
															namespaces : self
																	.xmlns()
														}) ]).dump({
											serialize : true,
											format : "application/rdf+xml"
										});
										self
												.editable({
													type : "textarea",
													mode : "inline",
													inputclass : "input-xxlarge",
													display : false,
													success : function(response) {
														if (response.html) {
															var newNode = $(response.html);
															newNode
																	.insertBefore(self);
															makeEditable(newNode);
														}
													},
													value : "",
													toggle : "manual",
													title : "Add value",
													url : function(params) {
														var d = new $.Deferred;
														setValue(
																{
																	rdf : stmt,
																	value : params.value,
																	templateName : self
																			.attr("data-create")
																},
																function(result) {
																	if (result.msg) {
																		d
																				.reject(result.msg);
																	} else {
																		d
																				.resolve(result);
																	}
																});
														return d.promise();
													}
												});
										self.editable("toggle");
									}
								}).css("cursor", "pointer");
			});
		</script>
		<style type="text/css" data-lift="head">
/* make buttons slightly transparent */
[data-create] {
	opacity: 0.3
}

#buttons .btn {
	opacity: 0.6
}

#buttons .btn:hover,[data-create]:hover {
	opacity: 1
}
</style>
		<div id="buttons" class="btn-toolbar" style="display: none">
			<div class="btn-group">
				<button class="btn btn-mini buttons-edit" title="Edit">
					<i class="icon-edit"></i>
				</button>
				<button class="btn btn-mini buttons-remove" title="Remove">
					<i class="icon-remove"></i>
				</button>
				<button class="btn btn-mini buttons-show" title="Show RDF">
					<i class="icon-eye-open"></i>
				</button>
			</div>
		</div>
		<div data-lift="Edit"></div>
		<div data-lift="JS.edit"></div>
	</div>
</body>
</html>
